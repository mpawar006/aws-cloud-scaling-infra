pipeline {
    agent any
    environment {
        DOCKERHUB_CREDENTIALS = credentials("d0ea9701-3da3-4121-a417-f23276419459")
    }
    stages {
        stage('git') {
            agent { label 'k8-m' }
            steps {
                git branch: 'main', url: 'https://github.com/mpawar006/aws-cloud-scaling-infra.git'
            }
        }

        stage('docker') {
            agent { label 'k8-m' }
            steps {
                sh 'sudo docker build . -t mpawar006/aws-cloud-scaling-infra'
                sh 'sudo docker login -u ${DOCKERHUB_CREDENTIALS_USR} -p ${DOCKERHUB_CREDENTIALS_PSW}'
                sh 'sudo docker push mpawar006/project2'
            }
        }

        stage('k8') {
            agent { label 'k8-m' }
            steps {
                // Injects the actual Build ID into your deploy.yaml
                sh "sed -i 's/REPLACE_ME/${env.BUILD_ID}/g' deploy.yaml"
                
                sh '''
                if kubectl get deploy website > /dev/null 2>&1;
                then
                  echo "Existing deployment found. Updating..."
                else
                  echo "No existing deployment found. Creating..."
                fi
                '''
                sh 'kubectl apply -f deploy.yaml'
                sh 'kubectl apply -f service.yaml'
            }
        }
    }
}
